<!DOCTYPE HTML>
<html>
<head>
  <title>SiteMy.Biz -> Santa Cruz</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.css">
  <link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.ie.css">

  <!-- Google Web Fonts -->
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Gudea|Patua+One">

  <!-- App Styles -->
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <div id="header">
    <h1 class="masthead">SiteMy.Biz</h1>
    <p class="tagline">Find commercial space for rent in Santa Cruz.</p>
    <ul style="display:none;">
      <li><a href="#">Submit a listing</a></li>
      <li><a href="#">About this site</a></li>
    </ul>
  </div>

  <!-- Detail container -->
  <div id="detail"></div>

  <!-- Map container -->
  <div id="map"></div>

  <!-- scripts -->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script src="http://code.leafletjs.com/leaflet-0.3.1/leaflet.js"></script>
  <script type="text/javascript">
$(document).ready(function() {
    
    // === MAP ===
    
    var map = new L.Map('map'),                         // Create map object and point it to <div id="map">
        mapCenter = new L.LatLng(36.97513,-122.024117), // Set map center to Santa Cruz
        mapZoom = 14;                                   // Set initial zoom level
    
    // === BASE LAYER ===
    
    // Create base layer (using Toner tiles from Stamen)
    var baseUrl = 'http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.jpg',
        attrib = 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.',
        baseLayer = new L.TileLayer(baseUrl, {attribution: attrib, maxZoom:18});
    
    // Add the base layer to map
    map.addLayer(baseLayer);
    
    // Center and zoom on base layer
    map.setView(mapCenter, mapZoom);
    
    // === AVAILABLE PARCEL LAYER ===
    
    // Create an empty layer where we will load the parcel polygons
    var parcelLayer = new L.GeoJSON();
    
    // Define default and highlight styles for the parcel polygons
    var defaultParcelStyle = {
            color: "#009900",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.5,
            fillColor: "#00FF00"
        },
        selectedParcelStyle = {
            color: '#2262CC',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.5,
            fillColor: '#2262CC'
        };
    
    // Define what happens to each polygon just before it is loaded onto
    // the map. This is Leaflet's special way of goofing around with your
    // data, setting styles and regulating user interactions.
    parcelLayer.on("featureparse", function (e) {

        // Load the default style
        e.layer.setStyle(defaultParcelStyle);
        
        // Create a self-invoking function that passes in the layer
        // and the properties associated with this particular record.
        (function(layer, properties) {
            
            // On mouseover, show details
            layer.on("mouseover", function (e) {
            
                // Change the style to the highlighted version
                layer.setStyle(selectedParcelStyle);
                
                // Create a popup with a unique ID linked to this record
                var popup = $("<div></div>", {
                    id: "popup-" + properties.APN,
                    css: {
                        backgroundColor: "#2262CC",
                        borderLeft: "5px solid #ccc",
                        color: "#FFFFFF",
                        top: "0",
                        padding: "1em 10px",
                        position: "absolute",
                        right: "0",
                        height: "100%",
                        width: "20%",
                        zIndex: 1002
                    }
                });

                var address = "",
                    zoning = "",
                    lease = "",
                    use = "",
                    footage = "";
                
                // address
                address = properties.property_address_street +
                          "<br>" +
                          properties.property_address_city +
                          " " +
                          properties.property_address_state +
                          ", " +
                          properties.property_address_zip;

                // zoning
                // TODO make this smell better
                if (properties.property_zoning_1_full) {
                    zoning = properties.property_zoning_1_full;
                }
                if (properties.property_zoning_1_full && properties.property_zoning_2_full) {
                    zoning = zoning + " and ";
                }
                if (properties.property_zoning_2_full) {
                    zoning = zoning + properties.property_zoning_2_full;
                }
                if ((properties.property_zoning_2_full && properties.property_zoning_3_full) || 
                   (properties.property_zoning_1_full && properties.property_zoning_3_full)) {
                    zoning = zoning + " and ";
                }
                if (properties.property_zoning_3_full) {
                    zoning = zoning + properties.property_zoning_3_full;
                }
                
                // lease cost and terms
                if (properties.property_gross) {
                    lease = '$' + properties.property_gross + '/ft<sup>2</sup> gross (<a href="#">What does this mean?</a>)';
                }
                if (properties.property_nnn) {
                    lease = '$' + properties.property_nnn + '/ft<sup>2</sup> NNN (<a href="#">What does this mean?</a>)';
                }
                if (lease === "") {
                    lease = "Lease terms unlisted. Lame.";
                }
                
                // use type
                if (properties.property_use_type_simple) {
                    use = properties.property_use_type_simple;
                }
                
                // square footage
                if (properties.property_footage) {
                    footage = properties.property_footage + " ft<sup>2</sup>";
                }
                if (properties.property_footage_range) {
                    footage = footage + "<br>(Range of " + properties.property_footage_range + " ft<sup>2</sup>)";
                }
                
                // Insert a headline into that popup
                var details = "<div>" + 
                              "<h3>Address</h3><p>" + address + "</p>" +
                              "<h3>Zoning</h3><p>" + zoning + "</p>" +
                              "<h3>APN</h3><p>" + properties.APN + "</p>" +
                              "<h3>Lease</h3><p>" + lease + "</p>" +
                              "<h3>Use</h3><p>" + use + "</p>" +
                              "<h3>Square Footage</h3><p>" + footage + "</p>" +
                              "<h3>Contact</h3><p>" + "[coming soon]" + "</p>" +
                              "</div>";
                $(details).appendTo(popup);
                // Add the popup to the map
                popup.appendTo("#map");
            });
            
            // On mouseout, undo the mouseover changes
            layer.on("mouseout", function (e) {
                // Reverting the style to default
                layer.setStyle(defaultParcelStyle);
                // Destroy the popup
                $("#popup-" + properties.APN).remove();
            });
          
        
        // Close the "anonymous" wrapper function, and call it while passing
        // in the variables necessary to make the events work the way we want.
        })(e.layer, e.properties);

    });
    
    // Gets all documents from MongoHQ recursively, 100 at a time
    function findParcels(collection, results, skipCount) {
        
        var dataUri = 'https://api.mongohq.com/databases/sitemybiz/collections/' + 
                      collection + "/" +
                      'documents?' +
                      '_apikey=' + 'unyeh7o6sy69tw0lw5y8' + '&' +
                      'limit=' + '100' + '&' + 
                      'skip=' + skipCount;
        
        // keep calling until we cannot get any more data from API
        $.getJSON(dataUri, function(data) {
            if (data.length > 0) {
                results = $.merge(results, data);
                skipCount += 100;
                findParcels(collection, results, skipCount);
            } else {
                // Add GeoJSON for parcel data into the parcel layer
                for (var i = 0; i < results.length; i++) {
                    parcelLayer.addGeoJSON(results[i]);
                }
                
                // Add parcel data layer to map
                map.addLayer(parcelLayer);
            }
        });
    }
    
    // Get parcel data from MongoHQ and plot it
    findParcels('available_parcels' , [], 0);
    
});
</script>

</body>
</html>